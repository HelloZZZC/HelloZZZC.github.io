
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="æ™¨æ™¨æ™¨æ™¨æ™¨æ™¨ğŸ¼&#39;s blog">
    <title>æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog - æ™¨æ™¨æ™¨æ™¨æ™¨æ™¨ğŸ¼&#39;s blog</title>
    <meta name="author" content="æ™¨æ™¨æ™¨æ™¨æ™¨æ™¨ğŸ¼">
    
        <meta name="keywords" content="Java,PHP,DevOps,">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"æ™¨æ™¨æ™¨æ™¨æ™¨æ™¨ğŸ¼","sameAs":["https://github.com/HelloZZZC"],"image":"avatar.jpg"},"articleBody":"å‰è¨€ä¸çŸ¥é“é˜…è¯»è¯¥ç¯‡æ–‡ç« çš„åŒå­¦æœ‰æ²¡æœ‰å¬è¯´è¿‡é˜¿é‡Œçš„Binlogå¢é‡è®¢é˜…ç»„ä»¶Canalã€‚é€šè¿‡Canalçš„ç®€ä»‹æˆ‘ä»¬ä¹Ÿèƒ½å¤§è‡´çœ‹å‡ºCanal Serveræ¨¡æ‹Ÿäº†Mysqlçš„SlaveèŠ‚ç‚¹å‘Masterå‘é€Dumpè¯·æ±‚æ¨é€Binlogæ—¥å¿—ï¼Œå†Canal Serveræ¥æ”¶åˆ°è¯·æ±‚åå¯¹æ—¥å¿—æ–‡ä»¶åšæ•°æ®è¿‡æ»¤ã€åŠ å·¥æœ€ç»ˆæ¨é€åˆ°ä¸‹æ¸¸å®¢æˆ·ç«¯ï¼ˆå¦‚ESã€Hbaseã€Kafkaï¼‰ä»¥å®ç°è¯¸å¦‚ä¸šåŠ¡Cacheåˆ·æ–°ã€ä¸šåŠ¡å¢é‡æ•°æ®å¤„ç†ç­‰ã€‚è¯¥ç¯‡æ–‡ç« ä¸»è¦é’ˆå¯¹Canal Serverå¦‚ä½•æ¨¡æ‹ŸSlaveèŠ‚ç‚¹å¹¶è®©MasterèŠ‚ç‚¹æ¨é€Binlogæ—¥å¿—ï¼ŒCanalç»„ä»¶è‚¯å®šä¼šå¯¹æ€§èƒ½å¦‚IOè¿™å—åšä¼˜åŒ–ï¼Œè¿™é‡Œå»ºè®®å»å­¦ä¹ Canalæ•´ä½“çš„æ¶æ„è®¾è®¡ã€‚\nä¸»ä»å¤åˆ¶åœ¨äº†è§£å¦‚ä½•ä¼ªè£…SlaveèŠ‚ç‚¹å‰ï¼Œæˆ‘è®¤ä¸ºå¾—å…ˆæµ…æµ…äº†è§£ä¸€ä¸‹Mysqlä¸»ä»å¤åˆ¶çš„åŸç†ï¼Œä¸‹å›¾æ˜¯Mysqlä¸»ä»å¤åˆ¶çš„åŸç†å›¾ï¼š\n\nSlaveåˆ›å»ºä¿©ä¸ªçº¿ç¨‹åˆ†åˆ«æ˜¯I/Oçº¿ç¨‹ã€SQLçº¿ç¨‹ã€‚\nSlaveåˆ›å»ºçš„I/Oçº¿ç¨‹å‘MasterèŠ‚ç‚¹è¯·æ±‚Binlogæ—¥å¿—ã€‚\nMasterä¸ºSlaveçš„I/Oçº¿ç¨‹åˆ›å»ºDumpçº¿ç¨‹Push Binlogæ—¥å¿—ã€‚\nSlaveçš„I/Oçº¿ç¨‹å°†æ•°æ®å†™å…¥RelayLogã€‚\nSlaveçš„SQLçº¿ç¨‹å¯¹è¯­å¥åˆ†æå¹¶æ‰§è¡Œã€‚\n\nå¦‚ä½•ä¼ªè£…Slaveä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥å¤§è‡´äº†è§£Canalçš„æµç¨‹ï¼Œé‚£æˆ‘ä»¬è¿™é‡Œè¿›å…¥æ­£é¢˜çœ‹çœ‹Canal Serverå¦‚ä½•ä¼ªè£…æˆSlaveèŠ‚ç‚¹ã€‚\nMysqlåè®®åŒ…å®šä¹‰æˆ‘ä»¬å¯ä»¥å¤§è‡´çŒœåˆ°éœ€è¦ä¼ªè£…æˆSlaveè‚¯å®šéœ€è¦è·ŸMysqlè¿›è¡ŒTCPè¿æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¾—å…ˆäº†è§£Mysqlé’ˆå¯¹é€šä¿¡åè®®çš„æ•°æ®åŒ…çš„ç»“æ„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šé¦–å…ˆMysqlåè®®å®šä¹‰çš„Packetï¼ŒHeaderå 4å­—èŠ‚åŒ…å«Payload_Lengthå 3ä¸ªå­—èŠ‚ã€SequenceIDå 1ä¸ªå­—èŠ‚ï¼ˆè¯¥å­—æ®µä»00å¼€å§‹å¹¶ä»¥ä¸€æ¬¡é€šä¿¡ç»“æŸåé‡æ–°å¼€å§‹ï¼Œå³Mysqlå‘é€OK_Parketã€Err_Packetï¼‰ï¼Œå…¶æ¬¡ç”±äºPayload_Lengthä»…æœ‰3ä¸ªå­—èŠ‚ï¼Œå› æ­¤Payloadæœ€å¤§ä¸º(2^24 - 1)Byteï¼Œå› æ­¤æ‰æœ‰äº†ä¸Šå›¾çš„ä¸‰ç§æƒ…å†µï¼Œå½“Payloadçš„é•¿åº¦ &lt; ffffffæ—¶ï¼Œåªéœ€å‘ä¸€ä¸ªåŒ…å³å¯ã€å½“Payloadçš„é•¿åº¦ = ffffffæ—¶ï¼Œéœ€è¦åœ¨å‘ä¸€ä¸ªç©ºåŒ…ã€å½“Payloadçš„é•¿åº¦ &gt; ffffffæ—¶ï¼Œéœ€è¦åˆ†åŒ…å‘é€ã€‚\nMysqlè¿æ¥ç”Ÿå‘½å‘¨æœŸè¿æ¥é˜¶æ®µé¦–å…ˆæˆ‘ä»¬éœ€è¦è·ŸMysqlå»ºç«‹è¿æ¥ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è¿›è¡ŒHandshakeï¼Œæˆ‘ä»¬çœ‹ä¸‹Mysqlè¿æ¥é˜¶æ®µçš„æµç¨‹ï¼š\n\nMysql Serverå‘å®¢æˆ·ç«¯å‘é€Initial Handshake Packetã€‚\nå®¢æˆ·ç«¯å‘Mysql Serverå‘é€Handshake Response Packetã€‚\nè‹¥è®¤è¯æˆåŠŸï¼ŒMysql Serverå‘å®¢æˆ·ç«¯å‘é€OK_Packetã€‚æ•´ä¸ªè¿‡ç¨‹æˆ‘ä»¬å¯ä»¥ç®€å•çš„æ¦‚æ‹¬ä¸ºå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯äº’ç›¸äº¤æ¢èƒ½åŠ›ä»¥åŠæœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯çš„è¿‡ç¨‹ã€‚ï¼ˆSSLæ¡æ‰‹ä¼šæ¯”æ™®é€šæ¡æ‰‹å¤šä¸€æ­¥SSLäº¤æ¢åˆ›å»ºSSLè¿æ¥çš„è¿‡ç¨‹ï¼Œä½†æœ¬æ–‡çš„é‡ç‚¹ä¸åœ¨æ­¤ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»Mysqlå®˜æ–¹æ–‡æ¡£å­¦ä¹ ã€‚ï¼‰\n\né’ˆå¯¹è¿æ¥é˜¶æ®µçš„è¡¥å……\nClientç«¯å¯å‘Serverç«¯å‘èµ·SSLæ¡æ‰‹ï¼Œæ–¹å¼æ˜¯Clientç«¯åœ¨æ¥æ”¶åˆ°Initial Handshake Packetåå›å¤Protocol::SSLRequestï¼Œé€šè¿‡SSL Exchangeä½¿å¾—å»ºç«‹SSLè¿æ¥ï¼Œä¹‹ååœ¨å›å¤Handshake Response Packetã€‚\nå½“æˆ‘ä»¬éœ€è¦çŸ¥é“Serverç«¯æ˜¯å¦æ”¯æŒæŸä¸ªCapabilityFlagæ—¶ï¼Œåªéœ€è¦å°†Serverç«¯è¿”å›çš„CapabilityFlagsæŒ‰ä½ä¸å…·ä½“çš„CapabilityFlagå³å¯ï¼Œå¦‚CLIENT_LONG_PASSWORD = CapabilityFlags &amp; CLIENT_LONG_PASSWORDã€‚åŒç†åœ¨å®¢æˆ·ç«¯éœ€è¦è®©æœåŠ¡ç«¯äº†è§£æˆ‘ä»¬éœ€è¦çš„èƒ½åŠ›åªéœ€å°†æˆ‘ä»¬éœ€è¦çš„é€»è¾‘æŒ‰ä½æˆ–å³å¯ï¼Œå¦‚CLIENT_LONG_PASSWORD | CLIENT_LONG_FLAGã€‚\n\nå®ç°ä»£ç Initial Handshake Packet123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103## Protocol::HandshakeV10 3.21.0ç‰ˆæœ¬ä¹‹åï¼Œéƒ½æ˜¯HandshakeV10çš„ç‰ˆæœ¬ã€‚æ—§ç‰ˆæœ¬åˆ™ä¸ºHandshakeV9ã€‚def parse_initial_handshake_packet(s):    \"\"\"    è§£æMysql Serverå‘çš„åŒ…    :param s:    :return:    1              [0a] protocol version    string[NUL]    server version    4              connection id    string[8]      auth-plugin-data-part-1    1              [00] filler    2              capability flags (lower 2 bytes)      if more data in the packet:    1              character set    2              status flags    2              capability flags (upper 2 bytes)      if capabilities &amp; CLIENT_PLUGIN_AUTH &#123;    1              length of auth-plugin-data      &#125; else &#123;    1              [00]      &#125;    string[10]     reserved (all [00])      if capabilities &amp; CLIENT_SECURE_CONNECTION &#123;    string[$len]   auth-plugin-data-part-2 ($len=MAX(13, length of auth-plugin-data - 8))      if capabilities &amp; CLIENT_PLUGIN_AUTH &#123;    string[NUL]    auth-plugin name      &#125;    \"\"\"    packet = []    input_buffer = s.recv(16384)    packet.append(input_buffer)    packet = b''.join(packet).hex()    index = 0    # int&lt;3&gt; 3ä¸ªå­—èŠ‚é•¿åº¦çš„payload_length    payload_length = packet[index:6]    index += 6    # int&lt;1&gt; 1ä¸ªå­—èŠ‚é•¿åº¦çš„sequence_id    sequence_id = packet[index:8]    index += 2    # int&lt;1&gt; 1ä¸ªå­—èŠ‚é•¿åº¦çš„åè®®ç­‰çº§    protocol_version = packet[index:10]    index += 2    # string&lt;NULL&gt; å·²NULLç»“å°¾çš„MysqlæœåŠ¡å™¨ç‰ˆæœ¬    server_version = ''    for i in range(int(len(packet[index:]) / 2)):        start = index        end = index + 2        server_version_part = packet[start:end]        server_version += server_version_part        index += 2        if server_version_part == '00':            break    # int&lt;4&gt; çº¿ç¨‹id    thread_id = packet[index:index + 8]    index += 8    # string&lt;8&gt; å¯†ç åŠ å¯†å‰8ä½    auth_plugin_data_part_1 = packet[index:index + 16]    index += 16    # int&lt;1&gt; å¡«å……ä½    filter_part = packet[index:index + 2]    index += 2    # int&lt;2&gt; åŠŸèƒ½æ ‡è¯†ä½ä½    capability_flags_1 = packet[index:index + 4]    index += 4    # int&lt;1&gt; å­—ç¬¦ç¼–ç æ ¼å¼    character_set = packet[index:index + 2]    index += 2    # int&lt;2&gt; æœåŠ¡å™¨çŠ¶æ€æ ‡è¯†    status_flags = packet[index:index + 4]    index += 4    # int&lt;2&gt; åŠŸèƒ½æ ‡è¯†é«˜ä½    capability_flags_2 = packet[index:index + 4]    index += 4    # int&lt;1&gt; åŠ å¯†éšæœºæ•°é•¿åº¦ï¼Œè‹¥ä¸æ”¯æŒCLIENT_PLUGIN_AUTHåˆ™ä¸º00    auth_plugin_data_len = packet[index:index + 2]    index += 2    # string&lt;10&gt; ä¿ç•™ä½ï¼Œéƒ½æ˜¯00    reserved = packet[index:index + 20]    index += 20    # string&lt;13&gt; å¯†ç åŠ å¯†å13ä½    auth_plugin_data_part_2 = packet[index:index + 26]    index += 26    # å·²NULLç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œç”¨æˆ·è®¤è¯æ–¹å¼åç§°    auth_plugin_name = packet[index:]        return &#123;        \"payload_length\": payload_length,        \"sequence_id\": sequence_id,        \"protocol_version\": protocol_version,        \"server_version\": server_version,        \"thread_id\": thread_id,        \"auth_plugin_data_part_1\": auth_plugin_data_part_1,        \"filter\": filter_part,        \"capability_flags_1\": capability_flags_1,        \"character_set\": character_set,        \"status_flags\": status_flags,        \"capability_flags_2\": capability_flags_2,        \"auth_plugin_data_len\": auth_plugin_data_len,        \"reserved\": reserved,        \"auth_plugin_data_part_2\": auth_plugin_data_part_2,        \"auth_plugin_name\": auth_plugin_name    &#125;\nHandshake Resp Packet\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566## Protocol::HandshakeResponse41 å½“Serverçš„CapabilityFlagsä¸æ”¯æŒCLIENT_PROTOCOL_41ï¼Œåˆ™åè®®ç‰ˆæœ¬ä¸ºHandshakeReponse320ã€‚def send_handshake_resp_packet(s, initial_resp):    \"\"\"    Clientå‘é€ç›¸åº”åŒ…    :param s:    :param initial_resp:    :return:    4              capability flags, CLIENT_PROTOCOL_41 always set    4              max-packet size    1              character set    string[23]     reserved (all [0])    string[NUL]    username      if capabilities &amp; CLIENT_PLUGIN_AUTH_LENENC_CLIENT_DATA &#123;    lenenc-int     length of auth-response    string[n]      auth-response      &#125; else if capabilities &amp; CLIENT_SECURE_CONNECTION &#123;    1              length of auth-response    string[n]      auth-response      &#125; else &#123;    string[NUL]    auth-response      &#125;      if capabilities &amp; CLIENT_CONNECT_WITH_DB &#123;    string[NUL]    database      &#125;      if capabilities &amp; CLIENT_PLUGIN_AUTH &#123;    string[NUL]    auth plugin name      &#125;      if capabilities &amp; CLIENT_CONNECT_ATTRS &#123;    lenenc-int     length of all key-values    lenenc-str     key    lenenc-str     value       if-more data in 'length of all key-values', more keys and value pairs      &#125;    \"\"\"    client_long_password = 1    client_long_flag = 4    client_connect_with_db = 8    client_protocol_41 = 512    client_interactive = 1024    client_transactions = 8192    client_secure_connection = 32768    client_multi_statements = 1 &lt;&lt; 16    client_plugin_auth = 1 &lt;&lt; 19    client_flag = (client_long_password | client_long_flag | client_connect_with_db | client_protocol_41 |                   client_interactive | client_transactions | client_secure_connection | client_multi_statements |                   client_plugin_auth).to_bytes(length=4, byteorder='little')    max_packet_size = b'\\x00\\xff\\xff\\xff'    character_set = b'\\x21'    filter_part = b'\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00'    user_name = 'canal'.encode('utf-8') + b'\\x00'    password = 'canal'.encode('utf-8')    auth_response = encrypt_password(        password,        initial_resp.get('auth_plugin_data_part_1'),        initial_resp.get('auth_plugin_data_part_2')    )    auth_response_length = len(auth_response).to_bytes(length=1, byteorder='little')    database = 'learning2'.encode('utf-8') + b'\\x00'    auth_plugin_name = 'mysql_native_password'.encode('utf-8') + b'\\x00'    payload = client_flag + max_packet_size + character_set + filter_part + user_name \\              + auth_response_length + auth_response + database + auth_plugin_name    header_length = len(payload).to_bytes(length=3, byteorder='little')    sequence_id = b'\\x01'    packet = header_length + sequence_id + payload    s.send(packet)\næ³¨æ„å¯†ç åŠ å¯†æ–¹å¼ï¼šauth_plugin_nameä¸ºmysql_native_passwordï¼Œå…¶å¯†ç åŠ å¯†æ–¹å¼ä¸ºï¼šSHA1(pwd) XOR SHA1(20 byte scramble concat SHA1(SHA1(pwd)))\nå‘½ä»¤è¡Œé˜¶æ®µå½“æˆ‘ä»¬åœ¨è¿æ¥é˜¶æ®µæ¥æ”¶åˆ°Mysql Serveræ¨é€çš„OK_Parcketè¯´æ˜å·²ç»è®¤è¯æˆåŠŸï¼Œä¹‹åMysqlå°†è¿›å…¥å‘½ä»¤è¡Œé˜¶æ®µï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥åƒMysqlå‘é€å‘½ä»¤å¦‚COM_REGISTER_SLAVEã€COM_BINLOG_DUMPå®ç°SlaveèŠ‚ç‚¹æ³¨å†Œä»¥åŠå‘Mysql Serverå‘é€Binlog Dumpå‘½ä»¤ã€‚\nå®ç°ä»£ç å‘é€æ³¨å†ŒSlave Command1234567891011121314151617181920212223242526272829303132333435def send_com_register_slave(s):    \"\"\"    å‘é€å‘½ä»¤æ³¨å†Œä»èŠ‚ç‚¹    :param s:    :return:    1              [15] COM_REGISTER_SLAVE    4              server-id    1              slaves hostname length    string[$len]   slaves hostname    1              slaves user len    string[$len]   slaves user    1              slaves password len    string[$len]   slaves password    2              slaves mysql-port    4              replication rank    4              master-id    \"\"\"    (localhost, local_port) = s.getsockname()    command = b'\\x15'    server_id = (3).to_bytes(length=4, byteorder='little')    hostname = localhost.encode('utf-8')    hostname_length = len(localhost.encode('utf-8')).to_bytes(length=1, byteorder='little')    slave_user = 'canal'.encode('utf-8')    slave_user_length = len(slave_user).to_bytes(length=1, byteorder='little')    slave_password = 'canal'.encode('utf-8')    slave_password_length = len(slave_password).to_bytes(length=1, byteorder='little')    slave_mysql_port = local_port.to_bytes(length=2, byteorder='little')    replication_rank = (0).to_bytes(length=4, byteorder='little')    master_id = (0).to_bytes(length=4, byteorder='little')    payload = command + server_id + hostname_length + hostname + slave_user_length + slave_user + \\              slave_password_length + slave_password + slave_mysql_port + replication_rank + master_id    header = len(payload).to_bytes(length=3, byteorder='little')    sequence_id = b'\\x00'    packet = header + sequence_id + payload    s.send(packet)\nå‘é€Binlog Dump Command123456789101112131415161718192021def send_com_binlog_dump(s):    \"\"\"    å‘é€dumpæ—¥å¿—çš„å‘½ä»¤    :param s:    :return:    1              [12] COM_BINLOG_DUMP    4              binlog-pos    2              flags    4              server-id    string[EOF]    binlog-filename    \"\"\"    command = b'\\x12'    binlog_pos = (100).to_bytes(length=4, byteorder='little')    flags = b'\\x00\\x00'    server_id = (3).to_bytes(length=4, byteorder='little')    binlog_filename = 'binlog.000502'.encode('utf-8')    payload = command + binlog_pos + flags + server_id + binlog_filename    header = len(payload).to_bytes(length=3, byteorder='little')    sequence_id = b'\\x00'    packet = header + sequence_id + payload    s.send(packet)\næ€»ç»“æˆ‘ä»¬é€šè¿‡äº†è§£Mysqlçš„ç”Ÿå‘½å‘¨æœŸçŸ¥é“å½“æˆ‘ä»¬è¿æ¥æˆåŠŸåå°†è¿›å…¥å‘½ä»¤è¡Œé˜¶æ®µï¼Œå®˜æ–¹å«Command Phaseã€‚æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥å‘Mysql Serverå‘é€å‘½ä»¤å®ç°Slaveçš„ä¼ªè£…ã€‚ä»¥ä¸Šä»£ç ä»…ä»…åªæ˜¯å±•ç¤ºäº†å¦‚ä½•å®ç°SlaveèŠ‚ç‚¹çš„æ³¨å†Œå’Œå‘é€Binlog DumpæŒ‡ä»¤ï¼Œå¯¹Canalå®Œæ•´æµç¨‹æ„Ÿå…´è¶£çš„åŒå­¦å»ºè®®å»é˜…è¯»æºç ï¼Œæ¯•ç«Ÿä¸€ä¸ªå¥½çš„ç»„ä»¶è®¾è®¡éœ€è¦è€ƒè™‘IOæ€§èƒ½ä¼˜åŒ–ï¼ˆè¯¸å¦‚é›¶æ‹·è´ã€NIOç­‰ï¼‰ã€ä»£ç çš„å¯æ‰©å±•æ€§ç­‰ç­‰ã€‚\n","dateCreated":"2024-01-30T17:03:27+08:00","dateModified":"2024-01-30T17:04:19+08:00","datePublished":"2024-01-30T17:03:27+08:00","description":"å‰è¨€ä¸çŸ¥é“é˜…è¯»è¯¥ç¯‡æ–‡ç« çš„åŒå­¦æœ‰æ²¡æœ‰å¬è¯´è¿‡é˜¿é‡Œçš„Binlogå¢é‡è®¢é˜…ç»„ä»¶Canalã€‚é€šè¿‡Canalçš„ç®€ä»‹æˆ‘ä»¬ä¹Ÿèƒ½å¤§è‡´çœ‹å‡ºCanal Serveræ¨¡æ‹Ÿäº†Mysqlçš„SlaveèŠ‚ç‚¹å‘Masterå‘é€Dumpè¯·æ±‚æ¨é€Binlogæ—¥å¿—ï¼Œå†Canal Serveræ¥æ”¶åˆ°è¯·æ±‚åå¯¹æ—¥å¿—æ–‡ä»¶åšæ•°æ®è¿‡æ»¤ã€åŠ å·¥æœ€ç»ˆæ¨é€åˆ°ä¸‹æ¸¸å®¢æˆ·ç«¯ï¼ˆå¦‚ESã€Hbaseã€Kafkaï¼‰ä»¥å®ç°è¯¸å¦‚ä¸šåŠ¡Cacheåˆ·æ–°ã€ä¸šåŠ¡å¢é‡æ•°æ®å¤„ç†ç­‰ã€‚è¯¥ç¯‡æ–‡ç« ä¸»è¦é’ˆå¯¹Canal Serverå¦‚ä½•æ¨¡æ‹ŸSlaveèŠ‚ç‚¹å¹¶è®©MasterèŠ‚ç‚¹æ¨é€Binlogæ—¥å¿—ï¼ŒCanalç»„ä»¶è‚¯å®šä¼šå¯¹æ€§èƒ½å¦‚IOè¿™å—åšä¼˜åŒ–ï¼Œè¿™é‡Œå»ºè®®å»å­¦ä¹ Canalæ•´ä½“çš„æ¶æ„è®¾è®¡ã€‚","headline":"æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"http://hellozzzc.github.io/2024/01/30/æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog/"},"publisher":{"@type":"Organization","name":"æ™¨æ™¨æ™¨æ™¨æ™¨æ™¨ğŸ¼","sameAs":["https://github.com/HelloZZZC"],"image":"avatar.jpg","logo":{"@type":"ImageObject","url":"avatar.jpg"}},"url":"http://hellozzzc.github.io/2024/01/30/æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog/","keywords":"Python, Mysql"}</script>
    <meta name="description" content="å‰è¨€ä¸çŸ¥é“é˜…è¯»è¯¥ç¯‡æ–‡ç« çš„åŒå­¦æœ‰æ²¡æœ‰å¬è¯´è¿‡é˜¿é‡Œçš„Binlogå¢é‡è®¢é˜…ç»„ä»¶Canalã€‚é€šè¿‡Canalçš„ç®€ä»‹æˆ‘ä»¬ä¹Ÿèƒ½å¤§è‡´çœ‹å‡ºCanal Serveræ¨¡æ‹Ÿäº†Mysqlçš„SlaveèŠ‚ç‚¹å‘Masterå‘é€Dumpè¯·æ±‚æ¨é€Binlogæ—¥å¿—ï¼Œå†Canal Serveræ¥æ”¶åˆ°è¯·æ±‚åå¯¹æ—¥å¿—æ–‡ä»¶åšæ•°æ®è¿‡æ»¤ã€åŠ å·¥æœ€ç»ˆæ¨é€åˆ°ä¸‹æ¸¸å®¢æˆ·ç«¯ï¼ˆå¦‚ESã€Hbaseã€Kafkaï¼‰ä»¥å®ç°è¯¸å¦‚ä¸šåŠ¡Cacheåˆ·æ–°ã€ä¸šåŠ¡å¢é‡æ•°æ®å¤„ç†ç­‰ã€‚è¯¥ç¯‡æ–‡">
<meta name="keywords" content="Python,Mysql">
<meta property="og:type" content="blog">
<meta property="og:title" content="æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog">
<meta property="og:url" content="http://hellozzzc.github.io/2024/01/30/æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog/index.html">
<meta property="og:site_name" content="æ™¨æ™¨æ™¨æ™¨æ™¨æ™¨ğŸ¼&#39;s blog">
<meta property="og:description" content="å‰è¨€ä¸çŸ¥é“é˜…è¯»è¯¥ç¯‡æ–‡ç« çš„åŒå­¦æœ‰æ²¡æœ‰å¬è¯´è¿‡é˜¿é‡Œçš„Binlogå¢é‡è®¢é˜…ç»„ä»¶Canalã€‚é€šè¿‡Canalçš„ç®€ä»‹æˆ‘ä»¬ä¹Ÿèƒ½å¤§è‡´çœ‹å‡ºCanal Serveræ¨¡æ‹Ÿäº†Mysqlçš„SlaveèŠ‚ç‚¹å‘Masterå‘é€Dumpè¯·æ±‚æ¨é€Binlogæ—¥å¿—ï¼Œå†Canal Serveræ¥æ”¶åˆ°è¯·æ±‚åå¯¹æ—¥å¿—æ–‡ä»¶åšæ•°æ®è¿‡æ»¤ã€åŠ å·¥æœ€ç»ˆæ¨é€åˆ°ä¸‹æ¸¸å®¢æˆ·ç«¯ï¼ˆå¦‚ESã€Hbaseã€Kafkaï¼‰ä»¥å®ç°è¯¸å¦‚ä¸šåŠ¡Cacheåˆ·æ–°ã€ä¸šåŠ¡å¢é‡æ•°æ®å¤„ç†ç­‰ã€‚è¯¥ç¯‡æ–‡">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="http://hellozzzc.github.io/assets/images/posts/canal_introduction.png">
<meta property="og:image" content="http://hellozzzc.github.io/assets/images/posts/master_slave.png">
<meta property="og:image" content="http://hellozzzc.github.io/assets/images/posts/canal_structure.png">
<meta property="og:image" content="http://hellozzzc.github.io/assets/images/posts/packet_defination.png">
<meta property="og:image" content="http://hellozzzc.github.io/assets/images/posts/mysql_connectoin_step.png">
<meta property="og:updated_time" content="2024-01-30T09:04:19.025Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog">
<meta name="twitter:description" content="å‰è¨€ä¸çŸ¥é“é˜…è¯»è¯¥ç¯‡æ–‡ç« çš„åŒå­¦æœ‰æ²¡æœ‰å¬è¯´è¿‡é˜¿é‡Œçš„Binlogå¢é‡è®¢é˜…ç»„ä»¶Canalã€‚é€šè¿‡Canalçš„ç®€ä»‹æˆ‘ä»¬ä¹Ÿèƒ½å¤§è‡´çœ‹å‡ºCanal Serveræ¨¡æ‹Ÿäº†Mysqlçš„SlaveèŠ‚ç‚¹å‘Masterå‘é€Dumpè¯·æ±‚æ¨é€Binlogæ—¥å¿—ï¼Œå†Canal Serveræ¥æ”¶åˆ°è¯·æ±‚åå¯¹æ—¥å¿—æ–‡ä»¶åšæ•°æ®è¿‡æ»¤ã€åŠ å·¥æœ€ç»ˆæ¨é€åˆ°ä¸‹æ¸¸å®¢æˆ·ç«¯ï¼ˆå¦‚ESã€Hbaseã€Kafkaï¼‰ä»¥å®ç°è¯¸å¦‚ä¸šåŠ¡Cacheåˆ·æ–°ã€ä¸šåŠ¡å¢é‡æ•°æ®å¤„ç†ç­‰ã€‚è¯¥ç¯‡æ–‡">
<meta name="twitter:image" content="http://hellozzzc.github.io/assets/images/posts/canal_introduction.png">
    
    
        
    
    
        <meta property="og:image" content="http://hellozzzc.github.io/assets/images/avatar.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-p7w8wxcc22z0uoeozhcztvvpgv2umorvyzcejj03qywn9okzjboqr0e7flor.min.css">
    <!--STYLES END-->
    

    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            æ™¨æ™¨æ™¨æ™¨æ™¨æ™¨ğŸ¼&#39;s blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="æ‰“å¼€é“¾æ¥: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/avatar.jpg" alt="ä½œè€…çš„å›¾ç‰‡"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="é˜…è¯»æœ‰å…³ä½œè€…çš„æ›´å¤šä¿¡æ¯"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/avatar.jpg" alt="ä½œè€…çš„å›¾ç‰‡"/>
                </a>
                <h4 class="sidebar-profile-name">æ™¨æ™¨æ™¨æ™¨æ™¨æ™¨ğŸ¼</h4>
                
                    <h5 class="sidebar-profile-bio"><p>å‡›å†¬æ•£å°½ï¼Œå¾…æ˜¥æ‹‚é¢ï¼Œæ˜Ÿæ²³é•¿æ˜ã€‚</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="é¦–é¡µ"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">é¦–é¡µ</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="åˆ†ç±»"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">åˆ†ç±»</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="æ ‡ç­¾"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">æ ‡ç­¾</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="å½’æ¡£"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">å½’æ¡£</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="æœç´¢"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">æœç´¢</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="å…³äº"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">å…³äº</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/HelloZZZC"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2024-01-30T17:03:27+08:00">
	
		    2024 å¹´ 1 æœˆ 30 æ—¥
    	
    </time>
    
        <span>å‘å¸ƒåœ¨ </span>
        
    <a class="category-link" href="/categories/åç«¯æŠ€æœ¯/">åç«¯æŠ€æœ¯</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¸çŸ¥é“é˜…è¯»è¯¥ç¯‡æ–‡ç« çš„åŒå­¦æœ‰æ²¡æœ‰å¬è¯´è¿‡é˜¿é‡Œçš„Binlogå¢é‡è®¢é˜…ç»„ä»¶<a href="https://github.com/alibaba/canal" target="_blank" rel="noopener">Canal</a>ã€‚é€šè¿‡Canalçš„ç®€ä»‹æˆ‘ä»¬ä¹Ÿèƒ½å¤§è‡´çœ‹å‡ºCanal Serveræ¨¡æ‹Ÿäº†Mysqlçš„SlaveèŠ‚ç‚¹å‘Masterå‘é€Dumpè¯·æ±‚æ¨é€Binlogæ—¥å¿—ï¼Œå†Canal Serveræ¥æ”¶åˆ°è¯·æ±‚åå¯¹æ—¥å¿—æ–‡ä»¶åšæ•°æ®è¿‡æ»¤ã€åŠ å·¥æœ€ç»ˆæ¨é€åˆ°ä¸‹æ¸¸å®¢æˆ·ç«¯ï¼ˆå¦‚ESã€Hbaseã€Kafkaï¼‰ä»¥å®ç°è¯¸å¦‚ä¸šåŠ¡Cacheåˆ·æ–°ã€ä¸šåŠ¡å¢é‡æ•°æ®å¤„ç†ç­‰ã€‚<br><img src="/assets/images/posts/canal_introduction.png" alt="canal-introduction"><br><strong>è¯¥ç¯‡æ–‡ç« ä¸»è¦é’ˆå¯¹Canal Serverå¦‚ä½•æ¨¡æ‹ŸSlaveèŠ‚ç‚¹å¹¶è®©MasterèŠ‚ç‚¹æ¨é€Binlogæ—¥å¿—ï¼ŒCanalç»„ä»¶è‚¯å®šä¼šå¯¹æ€§èƒ½å¦‚IOè¿™å—åšä¼˜åŒ–ï¼Œè¿™é‡Œå»ºè®®å»å­¦ä¹ Canalæ•´ä½“çš„æ¶æ„è®¾è®¡ã€‚</strong><br><a id="more"></a></p>
<h2 id="ä¸»ä»å¤åˆ¶"><a href="#ä¸»ä»å¤åˆ¶" class="headerlink" title="ä¸»ä»å¤åˆ¶"></a>ä¸»ä»å¤åˆ¶</h2><p>åœ¨äº†è§£å¦‚ä½•ä¼ªè£…SlaveèŠ‚ç‚¹å‰ï¼Œæˆ‘è®¤ä¸ºå¾—å…ˆæµ…æµ…äº†è§£ä¸€ä¸‹Mysqlä¸»ä»å¤åˆ¶çš„åŸç†ï¼Œä¸‹å›¾æ˜¯Mysqlä¸»ä»å¤åˆ¶çš„åŸç†å›¾ï¼š<br><img src="/assets/images/posts/master_slave.png" alt="master-slave"></p>
<ol>
<li>Slaveåˆ›å»ºä¿©ä¸ªçº¿ç¨‹åˆ†åˆ«æ˜¯I/Oçº¿ç¨‹ã€SQLçº¿ç¨‹ã€‚</li>
<li>Slaveåˆ›å»ºçš„I/Oçº¿ç¨‹å‘MasterèŠ‚ç‚¹è¯·æ±‚Binlogæ—¥å¿—ã€‚</li>
<li>Masterä¸ºSlaveçš„I/Oçº¿ç¨‹åˆ›å»ºDumpçº¿ç¨‹Push Binlogæ—¥å¿—ã€‚</li>
<li>Slaveçš„I/Oçº¿ç¨‹å°†æ•°æ®å†™å…¥RelayLogã€‚</li>
<li>Slaveçš„SQLçº¿ç¨‹å¯¹è¯­å¥åˆ†æå¹¶æ‰§è¡Œã€‚</li>
</ol>
<h2 id="å¦‚ä½•ä¼ªè£…Slave"><a href="#å¦‚ä½•ä¼ªè£…Slave" class="headerlink" title="å¦‚ä½•ä¼ªè£…Slave"></a>å¦‚ä½•ä¼ªè£…Slave</h2><p><img src="/assets/images/posts/canal_structure.png" alt="canal-structure"><br>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥å¤§è‡´äº†è§£Canalçš„æµç¨‹ï¼Œé‚£æˆ‘ä»¬è¿™é‡Œè¿›å…¥æ­£é¢˜çœ‹çœ‹Canal Serverå¦‚ä½•ä¼ªè£…æˆSlaveèŠ‚ç‚¹ã€‚</p>
<h3 id="Mysqlåè®®åŒ…å®šä¹‰"><a href="#Mysqlåè®®åŒ…å®šä¹‰" class="headerlink" title="Mysqlåè®®åŒ…å®šä¹‰"></a>Mysqlåè®®åŒ…å®šä¹‰</h3><p>æˆ‘ä»¬å¯ä»¥å¤§è‡´çŒœåˆ°éœ€è¦ä¼ªè£…æˆSlaveè‚¯å®šéœ€è¦è·ŸMysqlè¿›è¡ŒTCPè¿æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¾—å…ˆäº†è§£Mysqlé’ˆå¯¹é€šä¿¡åè®®çš„æ•°æ®åŒ…çš„ç»“æ„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="/assets/images/posts/packet_defination.png" alt="packet-defination"><br>é¦–å…ˆMysqlåè®®å®šä¹‰çš„Packetï¼ŒHeaderå 4å­—èŠ‚åŒ…å«Payload_Lengthå 3ä¸ªå­—èŠ‚ã€SequenceIDå 1ä¸ªå­—èŠ‚ï¼ˆè¯¥å­—æ®µä»00å¼€å§‹å¹¶ä»¥ä¸€æ¬¡é€šä¿¡ç»“æŸåé‡æ–°å¼€å§‹ï¼Œå³Mysqlå‘é€OK_Parketã€Err_Packetï¼‰ï¼Œå…¶æ¬¡ç”±äºPayload_Lengthä»…æœ‰3ä¸ªå­—èŠ‚ï¼Œå› æ­¤Payloadæœ€å¤§ä¸º(2^24 - 1)Byteï¼Œå› æ­¤æ‰æœ‰äº†ä¸Šå›¾çš„ä¸‰ç§æƒ…å†µï¼Œå½“Payloadçš„é•¿åº¦ &lt; ffffffæ—¶ï¼Œåªéœ€å‘ä¸€ä¸ªåŒ…å³å¯ã€å½“Payloadçš„é•¿åº¦ = ffffffæ—¶ï¼Œéœ€è¦åœ¨å‘ä¸€ä¸ªç©ºåŒ…ã€å½“Payloadçš„é•¿åº¦ &gt; ffffffæ—¶ï¼Œéœ€è¦åˆ†åŒ…å‘é€ã€‚</p>
<h3 id="Mysqlè¿æ¥ç”Ÿå‘½å‘¨æœŸ"><a href="#Mysqlè¿æ¥ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Mysqlè¿æ¥ç”Ÿå‘½å‘¨æœŸ"></a>Mysqlè¿æ¥ç”Ÿå‘½å‘¨æœŸ</h3><h4 id="è¿æ¥é˜¶æ®µ"><a href="#è¿æ¥é˜¶æ®µ" class="headerlink" title="è¿æ¥é˜¶æ®µ"></a>è¿æ¥é˜¶æ®µ</h4><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦è·ŸMysqlå»ºç«‹è¿æ¥ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è¿›è¡ŒHandshakeï¼Œæˆ‘ä»¬çœ‹ä¸‹Mysqlè¿æ¥é˜¶æ®µçš„æµç¨‹ï¼š<br><img src="/assets/images/posts/mysql_connectoin_step.png" alt="mysql-connectoin-step"></p>
<ol>
<li>Mysql Serverå‘å®¢æˆ·ç«¯å‘é€Initial Handshake Packetã€‚</li>
<li>å®¢æˆ·ç«¯å‘Mysql Serverå‘é€Handshake Response Packetã€‚</li>
<li>è‹¥è®¤è¯æˆåŠŸï¼ŒMysql Serverå‘å®¢æˆ·ç«¯å‘é€OK_Packetã€‚<br>æ•´ä¸ªè¿‡ç¨‹æˆ‘ä»¬å¯ä»¥ç®€å•çš„æ¦‚æ‹¬ä¸ºå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯äº’ç›¸äº¤æ¢èƒ½åŠ›ä»¥åŠæœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯çš„è¿‡ç¨‹ã€‚ï¼ˆSSLæ¡æ‰‹ä¼šæ¯”æ™®é€šæ¡æ‰‹å¤šä¸€æ­¥SSLäº¤æ¢åˆ›å»ºSSLè¿æ¥çš„è¿‡ç¨‹ï¼Œä½†æœ¬æ–‡çš„é‡ç‚¹ä¸åœ¨æ­¤ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»Mysqlå®˜æ–¹æ–‡æ¡£å­¦ä¹ ã€‚ï¼‰</li>
</ol>
<h5 id="é’ˆå¯¹è¿æ¥é˜¶æ®µçš„è¡¥å……"><a href="#é’ˆå¯¹è¿æ¥é˜¶æ®µçš„è¡¥å……" class="headerlink" title="é’ˆå¯¹è¿æ¥é˜¶æ®µçš„è¡¥å……"></a>é’ˆå¯¹è¿æ¥é˜¶æ®µçš„è¡¥å……</h5><ol>
<li>Clientç«¯å¯å‘Serverç«¯å‘èµ·SSLæ¡æ‰‹ï¼Œæ–¹å¼æ˜¯Clientç«¯åœ¨æ¥æ”¶åˆ°Initial Handshake Packetåå›å¤<a href="https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_connection_phase_packets_protocol_ssl_request.html" target="_blank" rel="noopener">Protocol::SSLRequest</a>ï¼Œé€šè¿‡SSL Exchangeä½¿å¾—å»ºç«‹SSLè¿æ¥ï¼Œä¹‹ååœ¨å›å¤Handshake Response Packetã€‚</li>
<li>å½“æˆ‘ä»¬éœ€è¦çŸ¥é“Serverç«¯æ˜¯å¦æ”¯æŒæŸä¸ª<a href="https://dev.mysql.com/doc/dev/mysql-server/latest/group__group__cs__capabilities__flags.html" target="_blank" rel="noopener">CapabilityFlag</a>æ—¶ï¼Œåªéœ€è¦å°†Serverç«¯è¿”å›çš„CapabilityFlagsæŒ‰ä½ä¸å…·ä½“çš„CapabilityFlagå³å¯ï¼Œå¦‚<a href="https://dev.mysql.com/doc/dev/mysql-server/latest/group__group__cs__capabilities__flags.html#ga52d3a3f2f6a84a0f427c16bd7bd3df1f" target="_blank" rel="noopener">CLIENT_LONG_PASSWORD</a> = CapabilityFlags &amp; CLIENT_LONG_PASSWORDã€‚åŒç†åœ¨å®¢æˆ·ç«¯éœ€è¦è®©æœåŠ¡ç«¯äº†è§£æˆ‘ä»¬éœ€è¦çš„èƒ½åŠ›åªéœ€å°†æˆ‘ä»¬éœ€è¦çš„é€»è¾‘æŒ‰ä½æˆ–å³å¯ï¼Œå¦‚CLIENT_LONG_PASSWORD | CLIENT_LONG_FLAGã€‚</li>
</ol>
<h5 id="å®ç°ä»£ç "><a href="#å®ç°ä»£ç " class="headerlink" title="å®ç°ä»£ç "></a>å®ç°ä»£ç </h5><p><strong>Initial Handshake Packet</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Protocol::HandshakeV10 3.21.0ç‰ˆæœ¬ä¹‹åï¼Œéƒ½æ˜¯HandshakeV10çš„ç‰ˆæœ¬ã€‚æ—§ç‰ˆæœ¬åˆ™ä¸ºHandshakeV9ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_initial_handshake_packet</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    è§£æMysql Serverå‘çš„åŒ…</span></span><br><span class="line"><span class="string">    :param s:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    1              [0a] protocol version</span></span><br><span class="line"><span class="string">    string[NUL]    server version</span></span><br><span class="line"><span class="string">    4              connection id</span></span><br><span class="line"><span class="string">    string[8]      auth-plugin-data-part-1</span></span><br><span class="line"><span class="string">    1              [00] filler</span></span><br><span class="line"><span class="string">    2              capability flags (lower 2 bytes)</span></span><br><span class="line"><span class="string">      if more data in the packet:</span></span><br><span class="line"><span class="string">    1              character set</span></span><br><span class="line"><span class="string">    2              status flags</span></span><br><span class="line"><span class="string">    2              capability flags (upper 2 bytes)</span></span><br><span class="line"><span class="string">      if capabilities &amp; CLIENT_PLUGIN_AUTH &#123;</span></span><br><span class="line"><span class="string">    1              length of auth-plugin-data</span></span><br><span class="line"><span class="string">      &#125; else &#123;</span></span><br><span class="line"><span class="string">    1              [00]</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    string[10]     reserved (all [00])</span></span><br><span class="line"><span class="string">      if capabilities &amp; CLIENT_SECURE_CONNECTION &#123;</span></span><br><span class="line"><span class="string">    string[$len]   auth-plugin-data-part-2 ($len=MAX(13, length of auth-plugin-data - 8))</span></span><br><span class="line"><span class="string">      if capabilities &amp; CLIENT_PLUGIN_AUTH &#123;</span></span><br><span class="line"><span class="string">    string[NUL]    auth-plugin name</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    packet = []</span><br><span class="line">    input_buffer = s.recv(<span class="number">16384</span>)</span><br><span class="line">    packet.append(input_buffer)</span><br><span class="line">    packet = <span class="string">b''</span>.join(packet).hex()</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="comment"># int&lt;3&gt; 3ä¸ªå­—èŠ‚é•¿åº¦çš„payload_length</span></span><br><span class="line">    payload_length = packet[index:<span class="number">6</span>]</span><br><span class="line">    index += <span class="number">6</span></span><br><span class="line">    <span class="comment"># int&lt;1&gt; 1ä¸ªå­—èŠ‚é•¿åº¦çš„sequence_id</span></span><br><span class="line">    sequence_id = packet[index:<span class="number">8</span>]</span><br><span class="line">    index += <span class="number">2</span></span><br><span class="line">    <span class="comment"># int&lt;1&gt; 1ä¸ªå­—èŠ‚é•¿åº¦çš„åè®®ç­‰çº§</span></span><br><span class="line">    protocol_version = packet[index:<span class="number">10</span>]</span><br><span class="line">    index += <span class="number">2</span></span><br><span class="line">    <span class="comment"># string&lt;NULL&gt; å·²NULLç»“å°¾çš„MysqlæœåŠ¡å™¨ç‰ˆæœ¬</span></span><br><span class="line">    server_version = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(int(len(packet[index:]) / <span class="number">2</span>)):</span><br><span class="line">        start = index</span><br><span class="line">        end = index + <span class="number">2</span></span><br><span class="line">        server_version_part = packet[start:end]</span><br><span class="line">        server_version += server_version_part</span><br><span class="line">        index += <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> server_version_part == <span class="string">'00'</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="comment"># int&lt;4&gt; çº¿ç¨‹id</span></span><br><span class="line">    thread_id = packet[index:index + <span class="number">8</span>]</span><br><span class="line">    index += <span class="number">8</span></span><br><span class="line">    <span class="comment"># string&lt;8&gt; å¯†ç åŠ å¯†å‰8ä½</span></span><br><span class="line">    auth_plugin_data_part_1 = packet[index:index + <span class="number">16</span>]</span><br><span class="line">    index += <span class="number">16</span></span><br><span class="line">    <span class="comment"># int&lt;1&gt; å¡«å……ä½</span></span><br><span class="line">    filter_part = packet[index:index + <span class="number">2</span>]</span><br><span class="line">    index += <span class="number">2</span></span><br><span class="line">    <span class="comment"># int&lt;2&gt; åŠŸèƒ½æ ‡è¯†ä½ä½</span></span><br><span class="line">    capability_flags_1 = packet[index:index + <span class="number">4</span>]</span><br><span class="line">    index += <span class="number">4</span></span><br><span class="line">    <span class="comment"># int&lt;1&gt; å­—ç¬¦ç¼–ç æ ¼å¼</span></span><br><span class="line">    character_set = packet[index:index + <span class="number">2</span>]</span><br><span class="line">    index += <span class="number">2</span></span><br><span class="line">    <span class="comment"># int&lt;2&gt; æœåŠ¡å™¨çŠ¶æ€æ ‡è¯†</span></span><br><span class="line">    status_flags = packet[index:index + <span class="number">4</span>]</span><br><span class="line">    index += <span class="number">4</span></span><br><span class="line">    <span class="comment"># int&lt;2&gt; åŠŸèƒ½æ ‡è¯†é«˜ä½</span></span><br><span class="line">    capability_flags_2 = packet[index:index + <span class="number">4</span>]</span><br><span class="line">    index += <span class="number">4</span></span><br><span class="line">    <span class="comment"># int&lt;1&gt; åŠ å¯†éšæœºæ•°é•¿åº¦ï¼Œè‹¥ä¸æ”¯æŒCLIENT_PLUGIN_AUTHåˆ™ä¸º00</span></span><br><span class="line">    auth_plugin_data_len = packet[index:index + <span class="number">2</span>]</span><br><span class="line">    index += <span class="number">2</span></span><br><span class="line">    <span class="comment"># string&lt;10&gt; ä¿ç•™ä½ï¼Œéƒ½æ˜¯00</span></span><br><span class="line">    reserved = packet[index:index + <span class="number">20</span>]</span><br><span class="line">    index += <span class="number">20</span></span><br><span class="line">    <span class="comment"># string&lt;13&gt; å¯†ç åŠ å¯†å13ä½</span></span><br><span class="line">    auth_plugin_data_part_2 = packet[index:index + <span class="number">26</span>]</span><br><span class="line">    index += <span class="number">26</span></span><br><span class="line">    <span class="comment"># å·²NULLç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œç”¨æˆ·è®¤è¯æ–¹å¼åç§°</span></span><br><span class="line">    auth_plugin_name = packet[index:]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">"payload_length"</span>: payload_length,</span><br><span class="line">        <span class="string">"sequence_id"</span>: sequence_id,</span><br><span class="line">        <span class="string">"protocol_version"</span>: protocol_version,</span><br><span class="line">        <span class="string">"server_version"</span>: server_version,</span><br><span class="line">        <span class="string">"thread_id"</span>: thread_id,</span><br><span class="line">        <span class="string">"auth_plugin_data_part_1"</span>: auth_plugin_data_part_1,</span><br><span class="line">        <span class="string">"filter"</span>: filter_part,</span><br><span class="line">        <span class="string">"capability_flags_1"</span>: capability_flags_1,</span><br><span class="line">        <span class="string">"character_set"</span>: character_set,</span><br><span class="line">        <span class="string">"status_flags"</span>: status_flags,</span><br><span class="line">        <span class="string">"capability_flags_2"</span>: capability_flags_2,</span><br><span class="line">        <span class="string">"auth_plugin_data_len"</span>: auth_plugin_data_len,</span><br><span class="line">        <span class="string">"reserved"</span>: reserved,</span><br><span class="line">        <span class="string">"auth_plugin_data_part_2"</span>: auth_plugin_data_part_2,</span><br><span class="line">        <span class="string">"auth_plugin_name"</span>: auth_plugin_name</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Handshake Resp Packet</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Protocol::HandshakeResponse41 å½“Serverçš„CapabilityFlagsä¸æ”¯æŒCLIENT_PROTOCOL_41ï¼Œåˆ™åè®®ç‰ˆæœ¬ä¸ºHandshakeReponse320ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_handshake_resp_packet</span><span class="params">(s, initial_resp)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Clientå‘é€ç›¸åº”åŒ…</span></span><br><span class="line"><span class="string">    :param s:</span></span><br><span class="line"><span class="string">    :param initial_resp:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    4              capability flags, CLIENT_PROTOCOL_41 always set</span></span><br><span class="line"><span class="string">    4              max-packet size</span></span><br><span class="line"><span class="string">    1              character set</span></span><br><span class="line"><span class="string">    string[23]     reserved (all [0])</span></span><br><span class="line"><span class="string">    string[NUL]    username</span></span><br><span class="line"><span class="string">      if capabilities &amp; CLIENT_PLUGIN_AUTH_LENENC_CLIENT_DATA &#123;</span></span><br><span class="line"><span class="string">    lenenc-int     length of auth-response</span></span><br><span class="line"><span class="string">    string[n]      auth-response</span></span><br><span class="line"><span class="string">      &#125; else if capabilities &amp; CLIENT_SECURE_CONNECTION &#123;</span></span><br><span class="line"><span class="string">    1              length of auth-response</span></span><br><span class="line"><span class="string">    string[n]      auth-response</span></span><br><span class="line"><span class="string">      &#125; else &#123;</span></span><br><span class="line"><span class="string">    string[NUL]    auth-response</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      if capabilities &amp; CLIENT_CONNECT_WITH_DB &#123;</span></span><br><span class="line"><span class="string">    string[NUL]    database</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      if capabilities &amp; CLIENT_PLUGIN_AUTH &#123;</span></span><br><span class="line"><span class="string">    string[NUL]    auth plugin name</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      if capabilities &amp; CLIENT_CONNECT_ATTRS &#123;</span></span><br><span class="line"><span class="string">    lenenc-int     length of all key-values</span></span><br><span class="line"><span class="string">    lenenc-str     key</span></span><br><span class="line"><span class="string">    lenenc-str     value</span></span><br><span class="line"><span class="string">       if-more data in 'length of all key-values', more keys and value pairs</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    client_long_password = <span class="number">1</span></span><br><span class="line">    client_long_flag = <span class="number">4</span></span><br><span class="line">    client_connect_with_db = <span class="number">8</span></span><br><span class="line">    client_protocol_41 = <span class="number">512</span></span><br><span class="line">    client_interactive = <span class="number">1024</span></span><br><span class="line">    client_transactions = <span class="number">8192</span></span><br><span class="line">    client_secure_connection = <span class="number">32768</span></span><br><span class="line">    client_multi_statements = <span class="number">1</span> &lt;&lt; <span class="number">16</span></span><br><span class="line">    client_plugin_auth = <span class="number">1</span> &lt;&lt; <span class="number">19</span></span><br><span class="line"></span><br><span class="line">    client_flag = (client_long_password | client_long_flag | client_connect_with_db | client_protocol_41 |</span><br><span class="line">                   client_interactive | client_transactions | client_secure_connection | client_multi_statements |</span><br><span class="line">                   client_plugin_auth).to_bytes(length=<span class="number">4</span>, byteorder=<span class="string">'little'</span>)</span><br><span class="line">    max_packet_size = <span class="string">b'\x00\xff\xff\xff'</span></span><br><span class="line">    character_set = <span class="string">b'\x21'</span></span><br><span class="line">    filter_part = <span class="string">b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'</span></span><br><span class="line">    user_name = <span class="string">'canal'</span>.encode(<span class="string">'utf-8'</span>) + <span class="string">b'\x00'</span></span><br><span class="line">    password = <span class="string">'canal'</span>.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    auth_response = encrypt_password(</span><br><span class="line">        password,</span><br><span class="line">        initial_resp.get(<span class="string">'auth_plugin_data_part_1'</span>),</span><br><span class="line">        initial_resp.get(<span class="string">'auth_plugin_data_part_2'</span>)</span><br><span class="line">    )</span><br><span class="line">    auth_response_length = len(auth_response).to_bytes(length=<span class="number">1</span>, byteorder=<span class="string">'little'</span>)</span><br><span class="line">    database = <span class="string">'learning2'</span>.encode(<span class="string">'utf-8'</span>) + <span class="string">b'\x00'</span></span><br><span class="line">    auth_plugin_name = <span class="string">'mysql_native_password'</span>.encode(<span class="string">'utf-8'</span>) + <span class="string">b'\x00'</span></span><br><span class="line">    payload = client_flag + max_packet_size + character_set + filter_part + user_name \</span><br><span class="line">              + auth_response_length + auth_response + database + auth_plugin_name</span><br><span class="line">    header_length = len(payload).to_bytes(length=<span class="number">3</span>, byteorder=<span class="string">'little'</span>)</span><br><span class="line">    sequence_id = <span class="string">b'\x01'</span></span><br><span class="line">    packet = header_length + sequence_id + payload</span><br><span class="line">    s.send(packet)</span><br></pre></td></tr></table></figure>
<p><strong>æ³¨æ„å¯†ç åŠ å¯†æ–¹å¼ï¼šauth_plugin_nameä¸ºmysql_native_passwordï¼Œå…¶å¯†ç åŠ å¯†æ–¹å¼ä¸ºï¼šSHA1(pwd) XOR SHA1(20 byte scramble concat SHA1(SHA1(pwd)))</strong></p>
<h4 id="å‘½ä»¤è¡Œé˜¶æ®µ"><a href="#å‘½ä»¤è¡Œé˜¶æ®µ" class="headerlink" title="å‘½ä»¤è¡Œé˜¶æ®µ"></a>å‘½ä»¤è¡Œé˜¶æ®µ</h4><p>å½“æˆ‘ä»¬åœ¨è¿æ¥é˜¶æ®µæ¥æ”¶åˆ°Mysql Serveræ¨é€çš„OK_Parcketè¯´æ˜å·²ç»è®¤è¯æˆåŠŸï¼Œä¹‹åMysqlå°†è¿›å…¥å‘½ä»¤è¡Œé˜¶æ®µï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥åƒMysqlå‘é€å‘½ä»¤å¦‚<strong>COM_REGISTER_SLAVE</strong>ã€<strong>COM_BINLOG_DUMP</strong>å®ç°SlaveèŠ‚ç‚¹æ³¨å†Œä»¥åŠå‘Mysql Serverå‘é€Binlog Dumpå‘½ä»¤ã€‚</p>
<h5 id="å®ç°ä»£ç -1"><a href="#å®ç°ä»£ç -1" class="headerlink" title="å®ç°ä»£ç "></a>å®ç°ä»£ç </h5><p><strong>å‘é€æ³¨å†ŒSlave Command</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_com_register_slave</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    å‘é€å‘½ä»¤æ³¨å†Œä»èŠ‚ç‚¹</span></span><br><span class="line"><span class="string">    :param s:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    1              [15] COM_REGISTER_SLAVE</span></span><br><span class="line"><span class="string">    4              server-id</span></span><br><span class="line"><span class="string">    1              slaves hostname length</span></span><br><span class="line"><span class="string">    string[$len]   slaves hostname</span></span><br><span class="line"><span class="string">    1              slaves user len</span></span><br><span class="line"><span class="string">    string[$len]   slaves user</span></span><br><span class="line"><span class="string">    1              slaves password len</span></span><br><span class="line"><span class="string">    string[$len]   slaves password</span></span><br><span class="line"><span class="string">    2              slaves mysql-port</span></span><br><span class="line"><span class="string">    4              replication rank</span></span><br><span class="line"><span class="string">    4              master-id</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    (localhost, local_port) = s.getsockname()</span><br><span class="line">    command = <span class="string">b'\x15'</span></span><br><span class="line">    server_id = (<span class="number">3</span>).to_bytes(length=<span class="number">4</span>, byteorder=<span class="string">'little'</span>)</span><br><span class="line">    hostname = localhost.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    hostname_length = len(localhost.encode(<span class="string">'utf-8'</span>)).to_bytes(length=<span class="number">1</span>, byteorder=<span class="string">'little'</span>)</span><br><span class="line">    slave_user = <span class="string">'canal'</span>.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    slave_user_length = len(slave_user).to_bytes(length=<span class="number">1</span>, byteorder=<span class="string">'little'</span>)</span><br><span class="line">    slave_password = <span class="string">'canal'</span>.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    slave_password_length = len(slave_password).to_bytes(length=<span class="number">1</span>, byteorder=<span class="string">'little'</span>)</span><br><span class="line">    slave_mysql_port = local_port.to_bytes(length=<span class="number">2</span>, byteorder=<span class="string">'little'</span>)</span><br><span class="line">    replication_rank = (<span class="number">0</span>).to_bytes(length=<span class="number">4</span>, byteorder=<span class="string">'little'</span>)</span><br><span class="line">    master_id = (<span class="number">0</span>).to_bytes(length=<span class="number">4</span>, byteorder=<span class="string">'little'</span>)</span><br><span class="line">    payload = command + server_id + hostname_length + hostname + slave_user_length + slave_user + \</span><br><span class="line">              slave_password_length + slave_password + slave_mysql_port + replication_rank + master_id</span><br><span class="line">    header = len(payload).to_bytes(length=<span class="number">3</span>, byteorder=<span class="string">'little'</span>)</span><br><span class="line">    sequence_id = <span class="string">b'\x00'</span></span><br><span class="line">    packet = header + sequence_id + payload</span><br><span class="line">    s.send(packet)</span><br></pre></td></tr></table></figure></p>
<p><strong>å‘é€Binlog Dump Command</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_com_binlog_dump</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    å‘é€dumpæ—¥å¿—çš„å‘½ä»¤</span></span><br><span class="line"><span class="string">    :param s:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    1              [12] COM_BINLOG_DUMP</span></span><br><span class="line"><span class="string">    4              binlog-pos</span></span><br><span class="line"><span class="string">    2              flags</span></span><br><span class="line"><span class="string">    4              server-id</span></span><br><span class="line"><span class="string">    string[EOF]    binlog-filename</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    command = <span class="string">b'\x12'</span></span><br><span class="line">    binlog_pos = (<span class="number">100</span>).to_bytes(length=<span class="number">4</span>, byteorder=<span class="string">'little'</span>)</span><br><span class="line">    flags = <span class="string">b'\x00\x00'</span></span><br><span class="line">    server_id = (<span class="number">3</span>).to_bytes(length=<span class="number">4</span>, byteorder=<span class="string">'little'</span>)</span><br><span class="line">    binlog_filename = <span class="string">'binlog.000502'</span>.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    payload = command + binlog_pos + flags + server_id + binlog_filename</span><br><span class="line">    header = len(payload).to_bytes(length=<span class="number">3</span>, byteorder=<span class="string">'little'</span>)</span><br><span class="line">    sequence_id = <span class="string">b'\x00'</span></span><br><span class="line">    packet = header + sequence_id + payload</span><br><span class="line">    s.send(packet)</span><br></pre></td></tr></table></figure></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ä»¬é€šè¿‡äº†è§£Mysqlçš„ç”Ÿå‘½å‘¨æœŸçŸ¥é“å½“æˆ‘ä»¬è¿æ¥æˆåŠŸåå°†è¿›å…¥å‘½ä»¤è¡Œé˜¶æ®µï¼Œå®˜æ–¹å«Command Phaseã€‚æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥å‘Mysql Serverå‘é€å‘½ä»¤å®ç°Slaveçš„ä¼ªè£…ã€‚ä»¥ä¸Šä»£ç ä»…ä»…åªæ˜¯å±•ç¤ºäº†å¦‚ä½•å®ç°SlaveèŠ‚ç‚¹çš„æ³¨å†Œå’Œå‘é€Binlog DumpæŒ‡ä»¤ï¼Œå¯¹Canalå®Œæ•´æµç¨‹æ„Ÿå…´è¶£çš„åŒå­¦å»ºè®®å»é˜…è¯»æºç ï¼Œæ¯•ç«Ÿä¸€ä¸ªå¥½çš„ç»„ä»¶è®¾è®¡éœ€è¦è€ƒè™‘IOæ€§èƒ½ä¼˜åŒ–ï¼ˆè¯¸å¦‚é›¶æ‹·è´ã€NIOç­‰ï¼‰ã€ä»£ç çš„å¯æ‰©å±•æ€§ç­‰ç­‰ã€‚</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">æ ‡ç­¾</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Mysql/">Mysql</a> <a class="tag tag--primary tag--small t-link" href="/tags/Python/">Python</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a
                        class="post-action-btn btn btn--disabled"
                        aria-hidden="true"
                    >
                        
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">ä¸Šä¸€ç¯‡</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2024/01/29/K8sç¬”è®°-é›†ç¾¤éƒ¨ç½²/"
                    data-tooltip="K8sç¬”è®°--é›†ç¾¤éƒ¨ç½²"
                    aria-label="ä¸‹ä¸€ç¯‡: K8sç¬”è®°--é›†ç¾¤éƒ¨ç½²"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">ä¸‹ä¸€ç¯‡</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="post.share"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://hellozzzc.github.io/2024/01/30/æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog/"
                    title="åˆ†äº«åˆ° Facebook"
                    aria-label="åˆ†äº«åˆ° Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://hellozzzc.github.io/2024/01/30/æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog/"
                    title="åˆ†äº«åˆ° Twitter"
                    aria-label="åˆ†äº«åˆ° Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://hellozzzc.github.io/2024/01/30/æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog/"
                    title="åˆ†äº«åˆ° Google+"
                    aria-label="åˆ†äº«åˆ° Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="post.back_to_top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2024 æ™¨æ™¨æ™¨æ™¨æ™¨æ™¨ğŸ¼. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a
                        class="post-action-btn btn btn--disabled"
                        aria-hidden="true"
                    >
                        
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">ä¸Šä¸€ç¯‡</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2024/01/29/K8sç¬”è®°-é›†ç¾¤éƒ¨ç½²/"
                    data-tooltip="K8sç¬”è®°--é›†ç¾¤éƒ¨ç½²"
                    aria-label="ä¸‹ä¸€ç¯‡: K8sç¬”è®°--é›†ç¾¤éƒ¨ç½²"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">ä¸‹ä¸€ç¯‡</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="post.share"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://hellozzzc.github.io/2024/01/30/æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog/"
                    title="åˆ†äº«åˆ° Facebook"
                    aria-label="åˆ†äº«åˆ° Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://hellozzzc.github.io/2024/01/30/æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog/"
                    title="åˆ†äº«åˆ° Twitter"
                    aria-label="åˆ†äº«åˆ° Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://hellozzzc.github.io/2024/01/30/æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog/"
                    title="åˆ†äº«åˆ° Google+"
                    aria-label="åˆ†äº«åˆ° Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="post.back_to_top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=http://hellozzzc.github.io/2024/01/30/æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog/"
                        aria-label="åˆ†äº«åˆ° Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>åˆ†äº«åˆ° Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=http://hellozzzc.github.io/2024/01/30/æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog/"
                        aria-label="åˆ†äº«åˆ° Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>åˆ†äº«åˆ° Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=http://hellozzzc.github.io/2024/01/30/æ¨¡æ‹ŸSlaveèŠ‚ç‚¹æ¥æ”¶Binlog/"
                        aria-label="åˆ†äº«åˆ° Google+"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>åˆ†äº«åˆ° Google+</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar.jpg" alt="ä½œè€…çš„å›¾ç‰‡"/>
        
            <h4 id="about-card-name">æ™¨æ™¨æ™¨æ™¨æ™¨æ™¨ğŸ¼</h4>
        
            <div id="about-card-bio"><p>å‡›å†¬æ•£å°½ï¼Œå¾…æ˜¥æ‹‚é¢ï¼Œæ˜Ÿæ²³é•¿æ˜ã€‚</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Javaå¼€å‘è€…ã€PHPå¼€å‘è€…ã€DevOpsçˆ±å¥½è€…</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                HangZhouï¼ŒChina
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover2.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-wvqkwyudmu38rhlubnd8ofdizi73uzvllg16bvdackcmqozxyrgohdhjllya.min.js"></script>
<!--SCRIPTS END-->


    




    </body>
</html>
